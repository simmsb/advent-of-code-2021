#!/usr/bin/env python3

enh = (
    """######.#..##..######.....#...#.#...#.######.#.#...#..#..#..###.#####.#.####...#.#.#...#.#.#...#####..###.....#.#.....#.#.#..###..#.#.#####..#.....####.##.##..#..##.#.##.##..##.#####.####.#.#....#...#...#...#.#########..#..#####..#.#.###....#.##.###...##.#..#....##.###...#..##.#..#...#.#.#####.####...#.##..##..#.#######...#..##.##.....#..#..#.###...###.######..##.#..##.######....#.##.##...###.##..#.#.#.#########....####.####.#.#...#.#.#..#.#.##.#...#.#..#######..###..##.#..####.###...#.#.#.##.#####.##.###.#.""".strip()
    .replace("\n", "")
    .replace("\r", "")
    .replace(" ", "")
)

enh = [v == "#" for v in enh]

inp = """
.##.##...#####.#######.##.##.#####..#.#.#.##.....##...#..#..###.#....###...##.....###......#..##...#
#..#...#.##..#.#..#....#...#...#....####..#.....#.#...##.#..##.##.##...#.#..#..####...#....##.##.##.
...#.#..#..###...##..#.##########...##...#.#.#.#.#####..###..###..##.#..#####..###......##.#.##...##
#..###.##.##...#.#..#.....#.##.#..#...#..####.#.#.##.###....#.#..#..##.#....#.#.#.###...###.#.####.#
...###.....###...##...#..######.###...##.#.##.###.#.#....###.##.###.###.###....######..##.#.#...#..#
###...#.##.#.###..#..#.####.#...#..#.#.#..#.#..#....###..##..####.##.##....#..##.#.##..#.#..#.#.##..
.###.##.#.....#.#.##.##.####.#..#.#..###.##...###..##..##.#.#...#..#.#####...#.####.#....######.#..#
..##.........##.##......##..#.#.#....#..####..#.#..###.##..#.##..####.#.#.##.#.#.##.....##....#.####
#..###..#...###.##.#.#....#.#....###....###...##.#..####.#####.#.##.#...#.#.#.##..#....#..#.#...##.#
###.#..#...#.##.#.#.#..#.####.###...##.####.#.#.........#.##..####.###..#.#...###..#.##..##...####..
#....###.##.##...###...##.###...#..##....#.##.#.##.#.##..#..##..#..#..#...#.##..##.###.#..##.#..###.
.#.#......##..#..#....#.##.#..##.##....#....#..###..##.##..###..#..#.#.##.#.##..#...#.#....#.#...#.#
#.#..#....#.##.##..#.###..##..####.##...##.#.#.###.#.#..#...#.##..#..#.###.....#.##.#####..#......#.
##.##...#.....##.....###.#..##...#.#...#.##..#........#######...#.###.#.#.##..##.#...###..#...#...#.
....###...###.#.#.#.###..#..####..######....###....####..##..#..#.#.###.#.#.#####...#..#.#.####...##
....#######.#....##...#####...###...#...#...#.#...#.###.#.####.#...#.#.#.###....#..#....#.#.#..##..#
#.####.###.#..#.#.#..#####.......##....####.##.####...#..###..#......#..#.#...#....##.....#.........
#..###.#..##.##..###.#.#.#.###.#....#.####.#.###.##.##..#...#.#.#..#..###..#..##......#.####..#.#.##
###.#..##.###....##.#####.###.....#....#####.#..#.#.#.##..#...##...###.##.##...###.##..#..#...#.#..#
#.#...#..#..#.###.#..#..##.#.#.....#.#.#....#.##...##.......####..#...#..#.......###..#.#.#....#..##
.##...##..#..#..####.##.......#...#.###..#..##.#.#.#.##..#..##.###.##.#.#.#..##.##.##..#..###.#..#.#
#...#.###.#......#...#.......##..##...##...#.#....##.#.##.##....##.######..##.##.####.#####....#.#..
#.##.####....##....#..#.#..#.####.#.####.###..##..#.....##.###.#...#...#..#..##.##.###...###.###.#.#
....#.##.##.###.#...#....#...###.#.#......#..#.###.#.#.#.#...#.#..###..#.##.#...##.######..#..####..
####...#.#.###.#...#.......##..#.#######...##...##..##......###.#####.#.#.#.###.#..#.#..##.##..###.#
#.#......#.#.####..##.##...#..######..#.#..#...#..#.####.#.##.#####.#..##..##.#.###.#.#.##.#.#.##.#.
..#.#..#.#...###.#..#.#.##.#.#....###.#..###..##..#######.#.##.####.....#.####.#.##.#...#####......#
#######...##.#.#.###..###.#..##..##...####..###.#.##.##.##...#.##.##.##....#.#..#.###...###.#.#.#...
.##.##..####..#.###########....#...#.#..##......##......#.#..###.##....#..#..#.#..###########..##.##
#....##...###..#.#.###.##......###.#.###.######.#..#.###.#.#.##..#....###.###.#.....#..#..#.#####..#
.######..#.###...###.#..##..#.####.###...###.#.#.####.########.#...#.#.##....####.###.#.##.###...#.#
###..##.##.....#...#.##...#.###...#.#.####..#.##..##..#....#..##.#######.##...#####...##.#...##.##..
###.#.#..###..##.#...####.#..###....###..###..###.###..#.##...#.....#...###.##.#.###.#####.#.##.#.#.
###..######.....#..#.....##.##.##.##...#.#..####....###.#.##...####.#....##.......##.#..###......#.#
##..#.###.##.######.#.##.#...#...###......##.###....##...#.#####.#.##.....#.#..#...####...###...##..
...###..###..##.##..####...##....##.#...#.##..###.###.####...##.#.#.##.#....#.#.###.#..#..#..#.#.##.
..#.###.#.#...#.###..##..##....#.#...#.##.####....#.#.#.#..###.#.#....###.##.#.#...#...#...#..##.#..
###...#.##..##.#..###.#.###.#..#.#.##.#.###...###.#...##.#.......#.#.###....####.....###.##.##.#.#..
.#.####..##.#.#..#######..#..###.#########.#...##..#..##.#.....#.#.##.#.....#.#######..###.....##..#
####.##....#..##.....#...#.#....##.#...####..###.###..#......###.###....##.#.#....###.###.#####..#..
.#.#...##.##.#...#.#...##..###.##..####.###..#....#######..#..##...#####..##...#.#.#######.####.#...
.#.###.######...##.##.#.##...####.#.......#.####.##.#.##.##.####.#...#.#..##....#####.##.#.##..#.#..
..#.#..###.....##....#.###....####.#.##.######..###.##..############.#...#...###.##.#..##.#..####..#
.#.....#.###.#.##....#...#.#####.#.#.##..#...###..##....#..#......#####.#.###..#..####...#####......
.##..#..........##.#.######....##.#.#...###.........#.##..##.......#..#.##......###.....##....#....#
#...#..#.#.#.#.#.####.#..#...#....##.#.#.#....##..#####......##.###.##..#..##...#.##...#....#.##.#..
...#..#.##.####.###.####....##...#......###.###.##....#...##.##.#..#.##.#.....#.##.#.##.##.#.###...#
..#..##.##.#.#####...#..###.#..###..#.####...#.#.##.#...#...#.#.#.###.#.#..##.##..#.##..#....#..###.
..#.#.###...##.#...#.#.#####...###.##...#..###.....#...##.#....##...###.##.####..#..##....#####.##.#
..#.#...#.###...##.##....##.####.....##.##....###..#...#.###..##.#.#.#.##..##...##....#.###.####.#.#
#...#####.##.#.#.#.#...#..###..#.##..##....#..#.###...#.####.###.##.#.##.##......####.....#####..###
.#.#.....#.######.#..#.##..###..#.###.###.##..#.##.....#......#..##.#...###.###..#.#..#.###...#.####
####.##.##.###..#.##.##.#.###.#...##...#..#.###.....#..##..###..#.#..#...#.##.#..#.##.#..#..#.#..#.#
#####.##.####.#######.#.##..##..#.#####..#..#.###..###..#..#.##...#..##.#####...###.#..##.#.###.#..#
...##..##.#.#.###..#.##.#.###....#...###.#####.#.#.#.#......#.###..#..##..#........#.#..#.##..#....#
#.#..#####.##.###...#...###..#.###.......#.#..#..#.#...###....####.###........#.###.####..####.#..#.
........#.##....#.##...#..##...##.####.##.#.##..##......###.#..#.#####..##.#.......##....##..##..#.#
..####.##...###..#####...#..####..###.##.#.#.#.#.....##.##...#.#....###..#..#.##....#...#.####...##.
..##..#.##....##.####.#.#..####.....#.###..#...##..##.#......##...###.....##.....#....##...##.##..##
.#.##...#####..##.##.#..#...#####....#.....#.##.#.##..#...###########...###..#.##.###....#.##.#####.
####......####.#####..###...#.####..#.#..###..#...##..##..#.#.#####.###.##.##..#####.##.#.###.##..#.
##.#..#.####.##..#..#.###.....###.#####.#.#####......#...##..#....##.#.##..###.#####..#.##.#..#..###
.##..####..###....#...#..#.###.#.##..#..#.###..###.##.##...#...##.#..#...#.###..#.###.#.##..##.##.##
#.##..##.#....###.###...#.#.###..#.######..##.#....###.#.###.####..#...#.#..#.#.##.###...##...#.#...
#.#.##.#..#.##....###..###...#...#.#..##.#..##.#..#.##..#.#..####.#....###.#..##..#...#.###.###..#.#
##.##..#####..##.##.##.##..#.....###..#..###..#.##.##.##.#..##.#..#..###.####..#.#####.##.#####.#.##
...###.#...#...###......###.#....##..##.##..########..###....###.####.#..###.######.##.......####.##
##.#.#..#.##.##..#...#...#....#....#....##.#..##.#......#.#.#.#...#.#.####.#.##..#..#.##.##.####...#
##.##...#.#.#.##..#.#....##...###.#####..###..#.###.###.#..###......##.###....##.#.##.####....#####.
.#.#.#####.#......#.##.#.###.#...#.##..#.#....###.##...#...#..##.####..####..###...#..##......###...
###.....##...#######..#.####.....#...#.#...#..#.###.##..#.#....#.#####..##.#.#.#####..#.#.####.#.##.
..#..##..#.#..#...#.#.....##.#.#..##..#.#...#.##.....#...###..##..#.#.#..####..#..#.#.###...#.##.#.#
#...##..#.######.##.#.###.#....#..#.#....#...########.....#####.####....#.##.##..#.#.#...#..##..###.
.#####..####.#..#..#.##.#...#..##.#..##...#....##.#.###......#.......#.....###.....##.####...##..###
##.#...#......###.#.....#..#######.##..#.#.#####..#....##..#..##.#...#.##..#...#.#...#.#.##.#.#####.
#.###..#.####..##..#######....#######..##...###..#.#..#....#.####....#...####.#..###.####...##.#.##.
.#..##..#.#.#.#######...#.#.#.#..#.....###.##..###...#.#.##.#..#.##...#..##..#...#.#...###...####...
...#.#.#.....#.######..##..#.###.###.#.#.###..#....##...###......#.##..#####...###...#...##.#...##..
#.#.......#.##......#...######.....#.###..#####..#.###.##..##...###.##..######...##.#..###.##.#..#.#
....#..##.#.....###.###.#....###..####....#.....###..#.....##.##.##.#..#.#.##...#.##..#.#....###...#
####....#.###..########.##......###....#####.#.#..###.#.#.##.######.#...##...#.###.##.#.....####..##
#####.####....#....###...#.#.#.###.#####..##...#...#.##..#######...#......#...#..####.##......#####.
..##.##.#..#.#.##..##.##..#..#....#.....#######...#..#......#.#.##...#.#.#....###...##..##.#...#.##.
.##.##.#....##.###....#.####....####..##....######.....####.####.#..#.....#####.##.#.##.######....#.
..#...#......##...#..#.#...#.#####..###..#.#..####....#...##.....#.#.#.##.##..#.#.###.##..#.####.#..
.#..#.##.#...#....####.##..##..#####..#..#.#####...##.#.#..####.#...##....#..#####.##.##..##.#..#..#
.##..#.###...#.#..###.###.#......######..#.#.####...#...#..##.########.##..#.###......#.##.#...#.#.#
...#.#..##..#....#..#####.#..######.#..#.#.#...##.######..##..####......#.##.##.#..#..#.##.##...#.#.
#..#.###.####.#.....#...#.....#..##.......#...#..###.###.#.....#.##.#..#.###....##..#...##.#....#...
.##...#..##..##.##...##.##..#.#.#..#.#.#####.####....#....#.#..#..#.#..#...#..#....#.#.#.######....#
#..##.##..#...#....#####....#####...#..#.##.##..##.#..#####.#..####.##.#.#####.#..##.#......##.#..##
#...##.#...#..###....####.##.#.#..#.#.#.#.#..#.#..#..##.#.#.#####...##.##.##.##.##.###...##..#...#.#
#.#..###.....#..####.#.###.######...#######.####..#..##..#.....##.###..#.#.##.###.#.#..##.#.###..###
....###..###.###....####....##..##...#..#...##.#...###..#..#.##...#......###.####...#...#..#.....#.#
#.#..##.##.....####.#..##...#.##.#..#.#.....##.####.#.##.##..#.....####.###.##..##...##...##.#..##.#
######..#.###.##..#......#.###.#.#.....##.###...##..##.###....##....##.##.#.#.#...#..#..#..###..#..#
..#...#...######.##.#.##..#.#.#.#.#.#.#####.####.######.####.##.#.#.#.#....#..#....####.#.##..#.#.##
####..#.##.#..###...##...###.###.####...#.##.####.###.###.##..####.##.#....#..###..#..##.##.#.....#.
.##.##.##.....#######.#..##.#...#.#####.#....##..#...#..##...##...#..#.#..#...#.#..#.###.###.##.###.
...##.#.#.##..#..#..#.#.....##..#.##..##.#..###..#...###......#.###..##..#####..##.###.##....#.##.#.
""".strip().splitlines()

enh = (
    """..#.#..#####.#.#.#.###.##.....###.##.#..###.####..#####..#....#..#..##..##
#..######.###...####..#..#####..##..#.#####...##.#.#..#.##..#.#......#.###
.######.###.####...#.##.##..#..#..#####.....#.#....###..#.##......#.....#.
.#..#..##..#...##.######.####.####.#.#...#.......#..#.#.#...####.##.#.....
.#..#...##.#.##..#...##.#.##..###.#......#.#.......#.#.#.####.###.##...#..
...####.#..#..#.##.#....##..#.####....##...##..#...#......#.#.......#.....
..##..####..#...#.#.#...##..#.#..###..#####........#..####......#..#""".strip()
    .replace("\n", "")
    .replace("\r", "")
    .replace(" ", "")
)

enh = [v == "#" for v in enh]

inp = """
#..#.
#....
##..#
..#..
..###""".strip().splitlines()

xr = (-4, len(inp[0]) + 4)
yr = (-4, len(inp[0]) + 4)
img = {}

for y, row in enumerate(inp):
    for x, v in enumerate(row):
        img[(x, y)] = v == "#"

pattern = [(-1, -1), (0, -1), (1, -1), (-1, 0), (0, 0), (1, 0), (-1, 1), (0, 1), (1, 1)]


def get_values(img: dict[tuple[int, int], bool], x, y, edge_colour) -> bool:
    b = 0

    pat = [
        *pattern[6:],
        *pattern[3:6],
        *pattern[:3],
    ]

    for dx, dy in pat:
        v = img.get((x + dx, y + dy), edge_colour)
        b |= v
        b <<= 1

    b >>= 1

    return enh[b]


def step(img: dict[tuple[int, int], bool], xr, yr, edge_colour):
    out = {}
    for x in range(*xr):
        for y in range(*yr):
            out[x, y] = get_values(img, x, y, edge_colour)
    return out, (xr[0] - 1, xr[1] + 1), (yr[0] - 1, yr[1] + 1)

def invert(img: dict):
    return {k: not v for k, v in img.items()}


def vis(img, xr, yr):
    print("\n".join(
        "".join("#" if img.get((x, y), False) else "." for x in range(*xr))
        for y in range(*yr)
    ))


edge_colour = False
for _ in range(2):
    vis(img, xr, yr)
    img, xr, yr = step(img, xr, yr, edge_colour)
    # edge_colour = not edge_colour
    #img = invert(img)

vis(img, xr, yr)
print(sum(1 for v in img.values() if v))

# 4872
# 5944
